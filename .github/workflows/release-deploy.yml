name: Release Deploy (Railway)

on:
  release:
    types: [published]

jobs:
  deploy:
    name: Trigger Railway Deploys
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect service changes
        id: detect
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail

          if git rev-parse "${RELEASE_TAG}" >/dev/null 2>&1; then
            CURRENT_TAG="${RELEASE_TAG}"
          else
            CURRENT_TAG="refs/tags/${RELEASE_TAG}"
          fi

          if PREV_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null); then
            RANGE="${PREV_TAG}..${CURRENT_TAG}"
            echo "range=${RANGE}" >> "$GITHUB_OUTPUT"

            if git diff --name-only "${RANGE}" -- "apps/raincloud/" | grep -q .; then
              echo "raincloud=true" >> "$GITHUB_OUTPUT"
            else
              echo "raincloud=false" >> "$GITHUB_OUTPUT"
            fi

            if git diff --name-only "${RANGE}" -- "apps/rainbot/" | grep -q .; then
              echo "rainbot=true" >> "$GITHUB_OUTPUT"
            else
              echo "rainbot=false" >> "$GITHUB_OUTPUT"
            fi

            if git diff --name-only "${RANGE}" -- "apps/pranjeet/" | grep -q .; then
              echo "pranjeet=true" >> "$GITHUB_OUTPUT"
            else
              echo "pranjeet=false" >> "$GITHUB_OUTPUT"
            fi

            if git diff --name-only "${RANGE}" -- "apps/hungerbot/" | grep -q .; then
              echo "hungerbot=true" >> "$GITHUB_OUTPUT"
            else
              echo "hungerbot=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "range=${CURRENT_TAG}" >> "$GITHUB_OUTPUT"
            echo "raincloud=true" >> "$GITHUB_OUTPUT"
            echo "rainbot=true" >> "$GITHUB_OUTPUT"
            echo "pranjeet=true" >> "$GITHUB_OUTPUT"
            echo "hungerbot=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy Raincloud to Railway
        if: ${{ secrets.RAILWAY_WEBHOOK_RAINCLOUD != '' && steps.detect.outputs.raincloud == 'true' }}
        run: |
          curl -X POST "${{ secrets.RAILWAY_WEBHOOK_RAINCLOUD }}" \
            -H "Content-Type: application/json" \
            -d '{}'

      - name: Deploy Rainbot Worker to Railway
        if: ${{ secrets.RAILWAY_WEBHOOK_RAINBOT != '' && steps.detect.outputs.rainbot == 'true' }}
        run: |
          curl -X POST "${{ secrets.RAILWAY_WEBHOOK_RAINBOT }}" \
            -H "Content-Type: application/json" \
            -d '{}'

      - name: Deploy Pranjeet Worker to Railway
        if: ${{ secrets.RAILWAY_WEBHOOK_PRANJEET != '' && steps.detect.outputs.pranjeet == 'true' }}
        run: |
          curl -X POST "${{ secrets.RAILWAY_WEBHOOK_PRANJEET }}" \
            -H "Content-Type: application/json" \
            -d '{}'

      - name: Deploy HungerBot Worker to Railway
        if: ${{ secrets.RAILWAY_WEBHOOK_HUNGERBOT != '' && steps.detect.outputs.hungerbot == 'true' }}
        run: |
          curl -X POST "${{ secrets.RAILWAY_WEBHOOK_HUNGERBOT }}" \
            -H "Content-Type: application/json" \
            -d '{}'
