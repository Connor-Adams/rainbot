name: Release Deploy (Railway)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      force:
        description: 'Force deploy (bypass CI + diff gating)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  checks: read

jobs:
  plan:
    name: Plan Railway Deploys
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.detect.outputs.matrix }}
      any: ${{ steps.detect.outputs.any }}
      services: ${{ steps.detect.outputs.services }}
      tag_sha: ${{ steps.tag.outputs.sha }}
      default_branch: ${{ steps.repo.outputs.default_branch }}

    steps:
      - name: Repo info
        id: repo
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            core.setOutput('default_branch', data.default_branch);

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tag SHA
        id: tag
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = context.payload.release?.tag_name;
            if (!tagName) {
              core.setFailed('Release tag not found in payload.');
              return;
            }
            const ref = `tags/${tagName}`;
            const { data: tagRef } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref,
            });
            core.setOutput('sha', tagRef.object.sha);

      - name: Verify tag on default branch (unless force)
        if: ${{ inputs.force != true }}
        run: |
          set -euo pipefail
          git fetch origin "${{ steps.repo.outputs.default_branch }}" --depth=200
          if ! git merge-base --is-ancestor "${{ steps.tag.outputs.sha }}" "origin/${{ steps.repo.outputs.default_branch }}"; then
            echo "Tag commit is not on default branch (${{
              steps.repo.outputs.default_branch
            }}). Refusing to deploy."
            exit 1
          fi

      - name: Verify CI status for tag (unless force)
        if: ${{ inputs.force != true }}
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ steps.tag.outputs.sha }}';
            const { data: status } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: sha,
            });
            const { data: checks } = await github.rest.checks.listSuitesForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: sha,
            });
            const hasChecks = checks.total_count > 0;
            const hasStatuses = status.total_count > 0;
            if (!hasChecks && !hasStatuses) {
              core.warning(`No CI status or check suites found for ${sha}; continuing deploy.`);
              return;
            }
            const failedChecks = checks.check_suites.filter((s) => s.conclusion && s.conclusion !== 'success');
            if (failedChecks.length > 0) {
              core.setFailed(`CI checks not successful for ${sha}: ${failedChecks.map((s) => s.conclusion).join(', ')}`);
              return;
            }
            if (hasStatuses && status.state !== 'success') {
              core.setFailed(`Commit status is ${status.state} for ${sha}`);
            }

      - name: Detect service changes
        id: detect
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail
          if ! command -v gh >/dev/null 2>&1; then
            echo "GitHub CLI not found; falling back to git describe for previous tag."
          fi

          if git rev-parse "${RELEASE_TAG}" >/dev/null 2>&1; then
            CURRENT_TAG="${RELEASE_TAG}"
          else
            CURRENT_TAG="refs/tags/${RELEASE_TAG}"
          fi

          PREV_TAG=""
          if command -v gh >/dev/null 2>&1; then
            if PREV_TAG_API=$(gh api repos/${GITHUB_REPOSITORY}/releases \
              --jq '.[] | select(.tag_name != env.RELEASE_TAG) | .tag_name' | head -n 1); then
              PREV_TAG="${PREV_TAG_API}"
            fi
          fi
          if [[ -z "${PREV_TAG}" ]]; then
            PREV_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || true)
          fi

          # No previous tag => deploy everything (first release)
          if [[ -z "${PREV_TAG}" ]]; then
            echo 'matrix={"include":[{"service":"raincloud","webhook":"RAILWAY_WEBHOOK_RAINCLOUD","health":"RAINCLOUD_HEALTH_URL"},{"service":"rainbot","webhook":"RAILWAY_WEBHOOK_RAINBOT","health":"RAINBOT_HEALTH_URL"},{"service":"pranjeet","webhook":"RAILWAY_WEBHOOK_PRANJEET","health":"PRANJEET_HEALTH_URL"},{"service":"hungerbot","webhook":"RAILWAY_WEBHOOK_HUNGERBOT","health":"HUNGERBOT_HEALTH_URL"}]}' >> "$GITHUB_OUTPUT"
            echo "any=true" >> "$GITHUB_OUTPUT"
            echo "services=raincloud,rainbot,pranjeet,hungerbot" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          RANGE="${PREV_TAG}..${CURRENT_TAG}"
          changed() { git diff --name-only "${RANGE}" -- "$1" | grep -q .; }

          SHARED=false
          if changed "packages/" || changed "ui/" || changed "package.json" || changed "yarn.lock" || changed "turbo.json"; then
            SHARED=true
          fi

          INC=""
          SERVICES=""
          add() {
            local service="$1" webhook="$2" health="$3"
            if [[ -n "${INC}" ]]; then INC="${INC},"; fi
            INC="${INC}{\"service\":\"${service}\",\"webhook\":\"${webhook}\",\"health\":\"${health}\"}"
            if [[ -n "${SERVICES}" ]]; then SERVICES="${SERVICES},"; fi
            SERVICES="${SERVICES}${service}"
          }

          if [[ "${SHARED}" == "true" ]] || changed "apps/raincloud/"; then
            add "raincloud" "RAILWAY_WEBHOOK_RAINCLOUD" "RAINCLOUD_HEALTH_URL"
          fi

          if [[ "${SHARED}" == "true" ]] || changed "apps/rainbot/"; then
            add "rainbot" "RAILWAY_WEBHOOK_RAINBOT" "RAINBOT_HEALTH_URL"
          fi

          if [[ "${SHARED}" == "true" ]] || changed "apps/pranjeet/"; then
            add "pranjeet" "RAILWAY_WEBHOOK_PRANJEET" "PRANJEET_HEALTH_URL"
          fi

          if [[ "${SHARED}" == "true" ]] || changed "apps/hungerbot/"; then
            add "hungerbot" "RAILWAY_WEBHOOK_HUNGERBOT" "HUNGERBOT_HEALTH_URL"
          fi

          if [[ -z "${INC}" ]]; then
            echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
            echo "any=false" >> "$GITHUB_OUTPUT"
            echo "services=" >> "$GITHUB_OUTPUT"
          else
            echo "matrix={\"include\":[${INC}]}" >> "$GITHUB_OUTPUT"
            echo "any=true" >> "$GITHUB_OUTPUT"
            echo "services=${SERVICES}" >> "$GITHUB_OUTPUT"
          fi

  deploy-raincloud:
    name: Deploy raincloud
    needs: [plan]
    if: ${{ needs.plan.outputs.any == 'true' && contains(needs.plan.outputs.services, 'raincloud') }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Railway deploy
        env:
          WEBHOOK: ${{ secrets.RAILWAY_WEBHOOK_RAINCLOUD }}
        run: |
          if [[ -z "${WEBHOOK}" ]]; then
            echo "RAILWAY_WEBHOOK_RAINCLOUD not set, skipping deploy."
            exit 0
          fi
          curl -fsSL --retry 5 --retry-all-errors --retry-delay 3 \
            -X POST "${WEBHOOK}" \
            -H "Content-Type: application/json" \
            -d '{}'
      - name: Smoke check (optional)
        env:
          HEALTH_URL: ${{ secrets.RAINCLOUD_HEALTH_URL }}
        run: |
          if [[ -z "${HEALTH_URL}" ]]; then
            echo "RAINCLOUD_HEALTH_URL not set, skipping smoke check."
            exit 0
          fi
          curl -fsSL --retry 10 --retry-all-errors --retry-delay 3 "${HEALTH_URL}"

  deploy-rainbot:
    name: Deploy rainbot
    needs: [plan]
    if: ${{ needs.plan.outputs.any == 'true' && contains(needs.plan.outputs.services, 'rainbot') }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Railway deploy
        env:
          WEBHOOK: ${{ secrets.RAILWAY_WEBHOOK_RAINBOT }}
        run: |
          if [[ -z "${WEBHOOK}" ]]; then
            echo "RAILWAY_WEBHOOK_RAINBOT not set, skipping deploy."
            exit 0
          fi
          curl -fsSL --retry 5 --retry-all-errors --retry-delay 3 \
            -X POST "${WEBHOOK}" \
            -H "Content-Type: application/json" \
            -d '{}'
      - name: Smoke check (optional)
        env:
          HEALTH_URL: ${{ secrets.RAINBOT_HEALTH_URL }}
        run: |
          if [[ -z "${HEALTH_URL}" ]]; then
            echo "RAINBOT_HEALTH_URL not set, skipping smoke check."
            exit 0
          fi
          curl -fsSL --retry 10 --retry-all-errors --retry-delay 3 "${HEALTH_URL}"

  deploy-pranjeet:
    name: Deploy pranjeet
    needs: [plan]
    if: ${{ needs.plan.outputs.any == 'true' && contains(needs.plan.outputs.services, 'pranjeet') }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Railway deploy
        env:
          WEBHOOK: ${{ secrets.RAILWAY_WEBHOOK_PRANJEET }}
        run: |
          if [[ -z "${WEBHOOK}" ]]; then
            echo "RAILWAY_WEBHOOK_PRANJEET not set, skipping deploy."
            exit 0
          fi
          curl -fsSL --retry 5 --retry-all-errors --retry-delay 3 \
            -X POST "${WEBHOOK}" \
            -H "Content-Type: application/json" \
            -d '{}'
      - name: Smoke check (optional)
        env:
          HEALTH_URL: ${{ secrets.PRANJEET_HEALTH_URL }}
        run: |
          if [[ -z "${HEALTH_URL}" ]]; then
            echo "PRANJEET_HEALTH_URL not set, skipping smoke check."
            exit 0
          fi
          curl -fsSL --retry 10 --retry-all-errors --retry-delay 3 "${HEALTH_URL}"

  deploy-hungerbot:
    name: Deploy hungerbot
    needs: [plan]
    if: ${{ needs.plan.outputs.any == 'true' && contains(needs.plan.outputs.services, 'hungerbot') }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Railway deploy
        env:
          WEBHOOK: ${{ secrets.RAILWAY_WEBHOOK_HUNGERBOT }}
        run: |
          if [[ -z "${WEBHOOK}" ]]; then
            echo "RAILWAY_WEBHOOK_HUNGERBOT not set, skipping deploy."
            exit 0
          fi
          curl -fsSL --retry 5 --retry-all-errors --retry-delay 3 \
            -X POST "${WEBHOOK}" \
            -H "Content-Type: application/json" \
            -d '{}'
      - name: Smoke check (optional)
        env:
          HEALTH_URL: ${{ secrets.HUNGERBOT_HEALTH_URL }}
        run: |
          if [[ -z "${HEALTH_URL}" ]]; then
            echo "HUNGERBOT_HEALTH_URL not set, skipping smoke check."
            exit 0
          fi
          curl -fsSL --retry 10 --retry-all-errors --retry-delay 3 "${HEALTH_URL}"
